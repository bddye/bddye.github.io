

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/icon.jpg">
  <link rel="icon" href="/img/icon.jpg">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="蹦跶的鱼儿">
  <meta name="keywords" content="MT19937逆向,AGCD,格,coppersmith">
  
    <meta name="description" content="2025.3.22NCTF是 2025.3.22NCTF 哒！ 爆0了…所以给出的我自己的脚本有些是不会与靶机交互的，但最后会给出官方的wp才不是我懒得写 绮云花灯百盏遥遥一线牵 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596">
<meta property="og:type" content="article">
<meta property="og:title" content="2025.3.22NCTF">
<meta property="og:url" content="https://bddye.github.io/2025/03/29/2025-3-22NCTF/index.html">
<meta property="og:site_name" content="蹦跶的鱼儿">
<meta property="og:description" content="2025.3.22NCTF是 2025.3.22NCTF 哒！ 爆0了…所以给出的我自己的脚本有些是不会与靶机交互的，但最后会给出官方的wp才不是我懒得写 绮云花灯百盏遥遥一线牵 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://bddye.github.io/2025/03/29/2025-3-22NCTF/1.png">
<meta property="og:image" content="https://bddye.github.io/2025/03/29/2025-3-22NCTF/2.png">
<meta property="og:image" content="https://bddye.github.io/2025/03/29/2025-3-22NCTF/3.png">
<meta property="og:image" content="https://bddye.github.io/2025/03/29/2025-3-22NCTF/4.png">
<meta property="og:image" content="https://bddye.github.io/2025/03/29/2025-3-22NCTF/5.png">
<meta property="og:image" content="https://bddye.github.io/2025/03/29/2025-3-22NCTF/6.png">
<meta property="og:image" content="https://bddye.github.io/2025/03/29/2025-3-22NCTF/7.png">
<meta property="og:image" content="https://bddye.github.io/2025/03/29/2025-3-22NCTF/8.jpg">
<meta property="article:published_time" content="2025-03-29T15:34:02.000Z">
<meta property="article:modified_time" content="2025-03-31T07:58:32.518Z">
<meta property="article:author" content="蹦跶的鱼儿">
<meta property="article:tag" content="crypto">
<meta property="article:tag" content="RSA">
<meta property="article:tag" content="NCTF">
<meta property="article:tag" content="LCG">
<meta property="article:tag" content="ECDSA">
<meta property="article:tag" content="格">
<meta property="article:tag" content="FHE">
<meta property="article:tag" content="MT19937">
<meta property="article:tag" content="RSA LSB Orcale">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://bddye.github.io/2025/03/29/2025-3-22NCTF/1.png">
  
  
  
  <title>2025.3.22NCTF - 蹦跶的鱼儿</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"bddye.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>蹦跶的鱼儿的池塘</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/background.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="2025.3.22NCTF"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-03-29 23:34" pubdate>
          2025年3月29日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          6.3k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          53 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">2025.3.22NCTF</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="2025-3-22NCTF"><a href="#2025-3-22NCTF" class="headerlink" title="2025.3.22NCTF"></a>2025.3.22NCTF</h1><p>是 <strong>2025.3.22NCTF</strong> 哒！</p>
<p>爆0了…所以给出的我自己的脚本有些是不会与靶机交互的，但最后会给出官方的wp<br><del>才不是我懒得写</del></p>
<h2 id="绮云"><a href="#绮云" class="headerlink" title="绮云"></a>绮云</h2><p>花灯百盏遥遥一线牵</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> os <span class="hljs-keyword">import</span> getenv,urandom<br><span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> sha256<br><span class="hljs-keyword">from</span> random <span class="hljs-keyword">import</span> randint<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ECDSA</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>.p = <span class="hljs-number">0xFFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFF</span><br>        <span class="hljs-variable language_">self</span>.a = <span class="hljs-number">0xFFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFC</span><br>        <span class="hljs-variable language_">self</span>.b = <span class="hljs-number">0x28E9FA9E9D9F5E344D5A9E4BCF6509A7F39789F515AB8F92DDBCBD414D940E93</span><br>        <span class="hljs-variable language_">self</span>.n = <span class="hljs-number">0xFFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123</span><br>        <span class="hljs-variable language_">self</span>.Gx = <span class="hljs-number">0x32C4AE2C1F1981195F9904466A39C9948FE30BBFF2660BE1715A4589334C74C7</span><br>        <span class="hljs-variable language_">self</span>.Gy = <span class="hljs-number">0xBC3736A2F4F6779C59BDCEE36B692153D0A9877CC62A474002DF32E52139F0A0</span><br>        <span class="hljs-variable language_">self</span>.G = (<span class="hljs-variable language_">self</span>.Gx,<span class="hljs-variable language_">self</span>.Gy)<br><br>        <span class="hljs-variable language_">self</span>.d = getPrime(<span class="hljs-number">232</span>)<br>        <span class="hljs-variable language_">self</span>.Q = <span class="hljs-variable language_">self</span>.mul(<span class="hljs-variable language_">self</span>.d,<span class="hljs-variable language_">self</span>.G)<br>        <span class="hljs-keyword">assert</span> <span class="hljs-variable language_">self</span>.is_on_curve(<span class="hljs-variable language_">self</span>.Q)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">is_on_curve</span>(<span class="hljs-params">self, point</span>):<br>        <span class="hljs-keyword">if</span> point <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        x, y = point<br>        <span class="hljs-keyword">return</span> (y**<span class="hljs-number">2</span> - x**<span class="hljs-number">3</span> - <span class="hljs-variable language_">self</span>.a * x - <span class="hljs-variable language_">self</span>.b) % <span class="hljs-variable language_">self</span>.p == <span class="hljs-number">0</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">self, p1, p2</span>):<br>        <span class="hljs-keyword">if</span> p1 <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">or</span> p2 <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">return</span> p1 <span class="hljs-keyword">if</span> p2 <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> p2<br><br>        x1, y1 = p1<br>        x2, y2 = p2<br><br>        <span class="hljs-keyword">if</span> x1 == x2 <span class="hljs-keyword">and</span> y1 != y2:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">if</span> x1 == x2:<br>            m = (<span class="hljs-number">3</span> * x1 * x1 + <span class="hljs-variable language_">self</span>.a) * <span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span> * y1, -<span class="hljs-number">1</span>,  <span class="hljs-variable language_">self</span>.p) % <span class="hljs-variable language_">self</span>.p<br>        <span class="hljs-keyword">else</span>:<br>            m = (y2 - y1) * <span class="hljs-built_in">pow</span>((x2 - x1) % <span class="hljs-variable language_">self</span>.p, -<span class="hljs-number">1</span>, <span class="hljs-variable language_">self</span>.p) % <span class="hljs-variable language_">self</span>.p<br>        <br>        x3 = (m * m - x1 - x2) % <span class="hljs-variable language_">self</span>.p<br>        y3 = (m * (x1 - x3) - y1) % <span class="hljs-variable language_">self</span>.p<br>        <span class="hljs-keyword">return</span> (x3, y3)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">mul</span>(<span class="hljs-params">self, k:<span class="hljs-built_in">int</span>, P:<span class="hljs-built_in">tuple</span>[<span class="hljs-built_in">int</span>,<span class="hljs-built_in">int</span>]</span>):<br>        <span class="hljs-keyword">if</span> P <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br>        <br>        R = <span class="hljs-literal">None</span>        <br>        <span class="hljs-keyword">while</span> k &gt; <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">if</span> k &amp; <span class="hljs-number">1</span>:<br>                R = <span class="hljs-variable language_">self</span>.add(R, P)<br>            P = <span class="hljs-variable language_">self</span>.add(P,P)<br>            k &gt;&gt;= <span class="hljs-number">1</span><br>        <span class="hljs-keyword">return</span> R<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_key_pair</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.d,<span class="hljs-variable language_">self</span>.Q<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">sign</span>(<span class="hljs-params">self, message</span>):<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            k = randint(<span class="hljs-number">1</span>, <span class="hljs-variable language_">self</span>.n - <span class="hljs-number">1</span>)<br>            P = <span class="hljs-variable language_">self</span>.mul(k, <span class="hljs-variable language_">self</span>.G)<br>            <span class="hljs-keyword">if</span> P <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                <span class="hljs-keyword">continue</span><br>            <br>            r = P[<span class="hljs-number">0</span>] % <span class="hljs-variable language_">self</span>.n<br>            <span class="hljs-keyword">if</span> r == <span class="hljs-number">0</span>:<br>                <span class="hljs-keyword">continue</span><br><br>            s = (<span class="hljs-built_in">pow</span>(k,-<span class="hljs-number">1</span>,<span class="hljs-variable language_">self</span>.n) * (<span class="hljs-built_in">int</span>.from_bytes(sha256(message).digest())+ <span class="hljs-variable language_">self</span>.d * r)) % <span class="hljs-variable language_">self</span>.n<br>            <span class="hljs-keyword">if</span> s != <span class="hljs-number">0</span>:<br>                <span class="hljs-keyword">return</span> (r, s)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">verify</span>(<span class="hljs-params">self, m:<span class="hljs-built_in">bytes</span>, r:<span class="hljs-built_in">int</span>,s:<span class="hljs-built_in">int</span></span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (<span class="hljs-number">1</span> &lt;= r &lt; <span class="hljs-variable language_">self</span>.n <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> &lt;= s &lt; <span class="hljs-variable language_">self</span>.n):<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>        <br>        u1 = (<span class="hljs-built_in">int</span>.from_bytes(sha256(m).digest()) * <span class="hljs-built_in">pow</span>(s,-<span class="hljs-number">1</span>,<span class="hljs-variable language_">self</span>.n)) % <span class="hljs-variable language_">self</span>.n<br>        u2 = (r * <span class="hljs-built_in">pow</span>(s,-<span class="hljs-number">1</span>,<span class="hljs-variable language_">self</span>.n)) % <span class="hljs-variable language_">self</span>.n<br><br>        <span class="hljs-keyword">if</span> u1 == <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> u2 == <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>        P = <span class="hljs-variable language_">self</span>.add(<span class="hljs-variable language_">self</span>.mul(u1, <span class="hljs-variable language_">self</span>.G), <span class="hljs-variable language_">self</span>.mul(u2, <span class="hljs-variable language_">self</span>.Q))        <br>        <span class="hljs-keyword">return</span> P[<span class="hljs-number">0</span>] % <span class="hljs-variable language_">self</span>.n == r<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RSA</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,d:<span class="hljs-built_in">int</span></span>):<br>        p = getStrongPrime(<span class="hljs-number">1024</span>)<br>        q = getStrongPrime(<span class="hljs-number">1024</span>)<br>        <br>        <span class="hljs-keyword">assert</span> GCD(d,(p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>)) == <span class="hljs-number">1</span><br><br>        <span class="hljs-variable language_">self</span>.N = p * q<br>        <span class="hljs-variable language_">self</span>.d = d<br>        <span class="hljs-variable language_">self</span>.e = <span class="hljs-built_in">pow</span>(d,-<span class="hljs-number">1</span>,(p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>))<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">encrypt</span>(<span class="hljs-params">self,m:<span class="hljs-built_in">int</span>,idx:<span class="hljs-built_in">int</span></span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">pow</span>(m,<span class="hljs-variable language_">self</span>.e ^ (<span class="hljs-number">1</span> &lt;&lt; idx),<span class="hljs-variable language_">self</span>.N)<br>    <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check</span>():<br>    r,s = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">map</span>(<span class="hljs-built_in">int</span>,<span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;Give me your signature:&#x27;</span>).split()))<br>    <span class="hljs-keyword">if</span> e.verify(<span class="hljs-string">f&#x27;nctf2024-<span class="hljs-subst">&#123;urandom(<span class="hljs-number">1</span>).<span class="hljs-built_in">hex</span>()&#125;</span>&#x27;</span>.encode(),r,s):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;Congratulations! Here is your flag: <span class="hljs-subst">&#123;getenv(<span class="hljs-string">&quot;FLAG&quot;</span>)&#125;</span>&#x27;</span>)<br>        exit()<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Wrong!&#x27;</span>)<br><br><br><span class="hljs-keyword">if</span> __name__==<span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    e = ECDSA()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Can you navigate yourself through QiYun Valley with only the encryption orcale?&#x27;</span>)<br><br>    menu = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">--- Menu ---</span><br><span class="hljs-string">[1] Initialize encryption orcale</span><br><span class="hljs-string">[2] Check your signature</span><br><span class="hljs-string">[3] Exit&#x27;&#x27;&#x27;</span><br><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-built_in">print</span>(menu)<br>        opt = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;Your option:&#x27;</span>).strip()<br>        <br>        <span class="hljs-keyword">if</span> opt==<span class="hljs-string">&#x27;1&#x27;</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Generating new public key pair for you...&#x27;</span>)<br>            rsa = RSA(e.d ** <span class="hljs-number">4</span>)<br><br>            <span class="hljs-keyword">while</span> <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;Enter &#x27;e&#x27; for encryption or other to exit:&quot;</span>).strip() == <span class="hljs-string">&quot;e&quot;</span>:<br>                m = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;Enter your message:&#x27;</span>),<span class="hljs-number">16</span>)<br>                x = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;Where do you want to interfere?&#x27;</span>))<br><br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;Result:<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rsa.encrypt(m,x))[<span class="hljs-number">2</span>:]&#125;</span>&#x27;</span>)<br><br>        <span class="hljs-keyword">elif</span> opt==<span class="hljs-string">&#x27;2&#x27;</span>:<br>            check()<br>        <br>        <span class="hljs-keyword">elif</span> opt==<span class="hljs-string">&#x27;3&#x27;</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Bye~&#x27;</span>)<br>            exit()<br><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Invalid option&#x27;</span>)<br></code></pre></td></tr></table></figure>
<p>题目允许我们:1.翻转e的任意一个比特位然后进行加密，返回加密结果;2.检查椭圆曲线的签名，正确就给flag。而椭圆曲线的d的4次方就是RSA的d。<br>我们需要通过明文和密文来推出e和n，进而推出d，再进行轻度的签名爆破即可。<br>首先要获取RSA的n。我是在lazzaro的博客里找到了这个<br><a target="_blank" rel="noopener" href="https://lazzzaro.github.io/2020/05/06/crypto-RSA/#%E9%80%89%E6%8B%A9%E6%98%8E-%E5%AF%86%E6%96%87%E6%94%BB%E5%87%BB">选择明&#x2F;密文攻击</a><br><img src="/2025/03/29/2025-3-22NCTF/1.png" srcset="/img/loading.gif" lazyload><br>让服务器加密明文<code>P</code>，得到结果<code>C1</code>，再加密明文<code>P**2</code>，得到结果<code>C2</code>，那么就能得到<code>C1**2-C2=kn</code>，再对另一个明文<code>P2</code>重复操作即可得到<code>k&#39;n</code>，对这两个结果求GCD即可得到n，可能会有一些小素数因子存在，去掉即可。<br>由题可知<code>GCD(e,(p-1)*(q-1))=1</code>，所以e一定是奇数，那么e的最低比特位一定是1。<br>我们就可以翻转最低比特位，再对2进行加密，返回的结果一定是<code>2**(e-1)%n</code>，结果再乘2模n即是<code>2**e%n</code>，我们就得到了未翻转任何比特位的加密结果。<br>之后，我们再继续翻转第k位比特位，把加密结果乘<code>2**(1&lt;&lt;k)</code>再模n，这个操作相当于把e的第k位加1。<br>如果这个比特位翻转前是1，那么翻转后就是0，加1后又变回了1，也就是说会得到未翻转比特位的e的加密结果。<br>所以，当我们把加密结果乘以<code>2**(1&lt;&lt;k)</code>后再模n，如果密文与前面得到的未翻转任何比特位的加密结果相同，说明这个比特位是1，反之是0<br>这里给出我比赛时用的得到n和e的脚本。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> sympy <span class="hljs-keyword">import</span> nextprime<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">t</span>(<span class="hljs-params">m:<span class="hljs-built_in">int</span>,x:<span class="hljs-built_in">int</span></span>):<br>    m=<span class="hljs-built_in">hex</span>(m)[<span class="hljs-number">2</span>:].encode()<br>    x=<span class="hljs-built_in">str</span>(x).encode()<br>    out=r.recvuntil(<span class="hljs-string">b&#x27;:&#x27;</span>)<br>    r.sendline(<span class="hljs-string">b&#x27;e&#x27;</span>)<br>    out=r.recvuntil(<span class="hljs-string">b&#x27;:&#x27;</span>)<br>    r.sendline(m)<br>    out=r.recvuntil(<span class="hljs-string">b&#x27;?&#x27;</span>)<br>    r.sendline(x)<br>    out=r.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>    out=<span class="hljs-built_in">int</span>(out.decode()[:-<span class="hljs-number">2</span>].split(<span class="hljs-string">&#x27;:&#x27;</span>)[-<span class="hljs-number">1</span>],<span class="hljs-number">16</span>)<br>    <span class="hljs-keyword">return</span> out<br>    <br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>r=remote(<span class="hljs-string">&#x27;39.106.16.204&#x27;</span>,<span class="hljs-number">16330</span>)<br><br>out=r.recv(<span class="hljs-number">400</span>)<br><span class="hljs-built_in">print</span>(out)<br><br>r.sendline(<span class="hljs-string">b&#x27;1&#x27;</span>)<br>out=r.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br><span class="hljs-built_in">print</span>(out)<br><br>c2=t(<span class="hljs-number">2</span>,<span class="hljs-number">0</span>)<br>c4=t(<span class="hljs-number">4</span>,<span class="hljs-number">0</span>)<br><br>c3=t(<span class="hljs-number">3</span>,<span class="hljs-number">0</span>)<br>c9=t(<span class="hljs-number">9</span>,<span class="hljs-number">0</span>)<br><br>c5=t(<span class="hljs-number">5</span>,<span class="hljs-number">0</span>)<br>c25=t(<span class="hljs-number">25</span>,<span class="hljs-number">0</span>)<br><br>n1=c2**<span class="hljs-number">2</span>-c4<br>n2=c3**<span class="hljs-number">2</span>-c9<br>n3=c5**<span class="hljs-number">2</span>-c25<br><br>n_=GCD(n1,n2)<br>n=GCD(n_,n3)<br><br><span class="hljs-comment">#检查是否有小素数因子，其实可能不需要检查这么多</span><br>pri=<span class="hljs-number">2</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>):<br>    <span class="hljs-keyword">while</span> n%pri==<span class="hljs-number">0</span>:<br>        n//=pri<br>    pri=nextprime(pri)<br><br><span class="hljs-built_in">print</span>(n)<br><br><span class="hljs-comment">#得到未翻转比特位的加密结果</span><br>c=c2*<span class="hljs-number">2</span>%n<br><br>e=[<span class="hljs-number">0</span>]*<span class="hljs-number">2049</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2049</span>):<br>    <span class="hljs-keyword">if</span> i%<span class="hljs-number">200</span>==<span class="hljs-number">0</span>:<br>        <span class="hljs-built_in">print</span>(i)<br>    <span class="hljs-keyword">if</span> t(<span class="hljs-number">2</span>,i)*<span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>,<span class="hljs-number">1</span>&lt;&lt;i,n)%n==c:<br>        e[i]=<span class="hljs-number">1</span><br>    <span class="hljs-keyword">else</span>:<br>        e[i]=<span class="hljs-number">0</span><br><br>e=<span class="hljs-built_in">int</span>(<span class="hljs-string">&#x27;&#x27;</span>.join(<span class="hljs-built_in">map</span>(<span class="hljs-built_in">str</span>,e[::-<span class="hljs-number">1</span>])),<span class="hljs-number">2</span>)<br><span class="hljs-built_in">print</span>(e)<br></code></pre></td></tr></table></figure>
<p>得到n,e后就不会了…<br>看了下wp是用格的，而且需要10组n,e，也就是说交互时间是非常长的。<br>wp的解释:<br><img src="/2025/03/29/2025-3-22NCTF/2.png" srcset="/img/loading.gif" lazyload><br>这是我复现的脚本:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sage">import gmpy2<br>#10组n和e<br>el=[]<br>nl=[]<br><br>length=11<br>B=[[0]*length for i in range(length)]<br>for i in range(len(B)-1):<br>    B[i][i]=nl[i]<br>    B[-1][i]=el[i]<br>B[-1][-1]=2^1024<br>B=matrix(ZZ,B)<br>B_=B.LLL()<br><br>d=B_[0][-1]//2^1024<br>d=gmpy2.iroot(d,4)<br>print(d)<br>d=d[0]<br></code></pre></td></tr></table></figure>
<figure class="highlight hy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs hy">(<span class="hljs-name">mpz</span>(<span class="hljs-number">3650017291377232489980231598072561018897386229012755703758171135449773</span>), <span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure>
<p>成功得到d。<br>之后用题目中的sign函数对随机一个byte签名即可，然后尝试verify，直到靶机随机到你签名的那个byte。<br>官方wp:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><code class="hljs sage">#sage<br>__import__(&#x27;os&#x27;).environ[&#x27;TERM&#x27;] = &#x27;xterm&#x27;<br><br>from pwn import *<br>from sage.all import *<br>from time import time<br>from hashlib import sha256<br><br>io = remote(&#x27;39.106.16.204&#x27;, 10645)<br># io = process([&#x27;python3&#x27;, &#x27;task.py&#x27;])<br><br>nls = []<br>els = []<br><br>recv_hexint = lambda: int(io.recvline().strip().decode(), 16)<br><br>t0 = time()<br><br>for _ in range(10):<br>    io.sendlineafter(b&#x27;option:&#x27;, b&#x27;1&#x27;)<br>    # decipher N via GCD<br><br>    numls = []<br>    for i in range(9):<br>        msg = int(1 &lt;&lt; (i + 1)).to_bytes(2, &#x27;big&#x27;)<br>        io.sendlineafter(b&#x27;exit:&#x27;, b&#x27;e&#x27;)<br>        io.sendlineafter(b&#x27;message:&#x27;, msg.hex().encode())<br>        io.sendlineafter(b&#x27;interfere?&#x27;, b&#x27;0&#x27;)<br>        io.recvuntil(b&#x27;Result:&#x27;)<br>        numls.append(int(io.recvline().strip().decode(), 16))<br><br>    gcdls = []<br>    for i in range(1, 9):<br>        gcdls.append(numls[0] ^ (i + 1) - numls[i])<br><br>    n = gcd(gcdls)<br>    nls.append(n)<br>    print(f&#x27;n #&#123;_&#125; = &#123;n&#125;&#x27;)<br><br>    # decipher e via fault injection of e<br><br>    orcale_msg = 3<br><br>    io.sendlineafter(b&#x27;exit:&#x27;, b&#x27;e&#x27;)<br>    io.sendlineafter(b&#x27;message:&#x27;, int(orcale_msg).to_bytes(1, &#x27;big&#x27;).hex().encode())<br>    io.sendlineafter(b&#x27;interfere?&#x27;, b&#x27;2048&#x27;)<br>    io.recvuntil(b&#x27;Result:&#x27;)<br>    basis = recv_hexint() * pow(orcale_msg, -2**2048, n) % n  # basis, = pow(m,e,n)<br><br>    e_rng = [0] * 2048<br><br>    for i in range(2048):<br>        io.sendlineafter(b&#x27;exit:&#x27;, b&#x27;e&#x27;)<br>        io.sendlineafter(b&#x27;message:&#x27;, int(orcale_msg).to_bytes(1, &#x27;big&#x27;).hex().encode())<br>        io.sendlineafter(b&#x27;interfere?&#x27;, str(i).encode())<br>        io.recvuntil(b&#x27;Result:&#x27;)<br><br>        temp = recv_hexint()<br>        multiplier = pow(orcale_msg, 2**i, n)<br><br>        if temp == basis * multiplier % n:  # 0 -&gt; 1, original = 0<br>            e_rng[i] = 0<br>        else:  # 1 -&gt; 0, original = 1<br>            assert temp == basis * pow(multiplier, -1, n) % n  # ensure<br>            e_rng[i] = 1<br><br>    e_res = int(&#x27;&#x27;.join(str(i) for i in e_rng)[::-1], 2)<br>    assert pow(orcale_msg, e_res, n) == basis<br>    els.append(e_res)<br><br>    print(f&#x27;e #&#123;_&#125; = &#123;e_res&#125;&#x27;)<br>    print(f&#x27;Time elasped: &#123;time() - t0:.2f&#125;s&#x27;)<br>    io.sendlineafter(b&#x27;exit:&#x27;, b&#x27;&#x27;)<br><br>const = 2**1024<br>mt = matrix.diagonal(ZZ, nls + [0]).dense_matrix()<br>mt[-1] = els + [const]<br>mt = mt.LLL()<br><br>temp = abs(mt[0, -1])<br>assert temp % const == 0<br>d = ZZ(temp / const)<br><br>x = d.nth_root(4)<br>E = EllipticCurve(Zmod(0xFFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFF), [0xFFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFC, 0x28E9FA9E9D9F5E344D5A9E4BCF6509A7F39789F515AB8F92DDBCBD414D940E93])<br>n = 0xFFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123<br><br>G = E((0x32C4AE2C1F1981195F9904466A39C9948FE30BBFF2660BE1715A4589334C74C7, 0xBC3736A2F4F6779C59BDCEE36B692153D0A9877CC62A474002DF32E52139F0A0))<br>m0 = int.from_bytes(sha256(&#x27;nctf2024-00&#x27;.encode()).digest(), &#x27;big&#x27;)<br><br>while True:<br>    k = int(time() * 1000)  # any random number smaller than n<br>    P = k * G<br>    r = int(P.xy()[0]) % n<br>    s = (pow(k, -1, n) * (m0 + x * r)) % n<br>    if r != 0 and s != 0:<br>        break<br><br>send = f&#x27;&#123;r&#125; &#123;s&#125;&#x27;.encode()<br>while True:<br>    io.sendlineafter(b&#x27;option:&#x27;, b&#x27;2&#x27;)<br>    io.sendlineafter(b&#x27;:&#x27;, send)<br>    msg = io.recvline()<br>    if b&#x27;flag&#x27; in msg:<br>        print(msg.decode())<br>        break<br><br>io.close()<br></code></pre></td></tr></table></figure>

<h2 id="Sign"><a href="#Sign" class="headerlink" title="Sign"></a>Sign</h2><p>这是恢复互联网的密钥，密码是实时生成的三万个随机数。<br>srv.py:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> util <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> os <span class="hljs-keyword">import</span> getenv<br><span class="hljs-keyword">from</span> Crypto.Util.Padding <span class="hljs-keyword">import</span> pad<br><span class="hljs-keyword">from</span> random <span class="hljs-keyword">import</span> Random<br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br><span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> md5<br><br>string = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;secret.txt&#x27;</span>).read().strip().encode()<br>flag = getenv(<span class="hljs-string">&#x27;FLAG&#x27;</span>).encode()<br><br><span class="hljs-keyword">if</span> __name__==<span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    Keys = []<br>    <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> string:<br>        f = FHE()<br>        s = long_to_bytes(Random().getrandbits(<span class="hljs-number">20000</span>))<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> s[<span class="hljs-number">4</span>:]:<br>            Keys.extend(f.encrypt([i]))<br><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> s[:<span class="hljs-number">4</span>]:<br>            Keys.extend(f.encrypt([i * (m &amp; <span class="hljs-number">0x03</span>) % <span class="hljs-number">0x101</span>]))<br>            m &gt;&gt;= <span class="hljs-number">2</span><br>        <br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(Keys) == <span class="hljs-number">30000</span><br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;[+] Your ciphertext: <span class="hljs-subst">&#123;AES.new(md5(string).digest(),AES.MODE_ECB).encrypt(pad(flag,<span class="hljs-number">16</span>)).<span class="hljs-built_in">hex</span>()&#125;</span>&#x27;</span>)<br>    <span class="hljs-built_in">input</span>(<span class="hljs-string">f&#x27;[+] The keys to retrieve the global internet connection are as follows:&#x27;</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">30000</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;[+] <span class="hljs-subst">&#123;Keys[i]&#125;</span>&#x27;</span>)<br></code></pre></td></tr></table></figure>
<p>util.py:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> os <span class="hljs-keyword">import</span> urandom<br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getrandint</span>(<span class="hljs-params">n:<span class="hljs-built_in">int</span></span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">int</span>.from_bytes(urandom(n//<span class="hljs-number">8</span>+<span class="hljs-number">1</span>)) % <span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>,n)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">FHE</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>.p = getPrime(<span class="hljs-number">77</span>)<br>        <span class="hljs-variable language_">self</span>.pubkeys = []<br>        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):<br>            <span class="hljs-variable language_">self</span>.pubkeys.append(<span class="hljs-variable language_">self</span>.p * getrandint(<span class="hljs-number">177</span>) + (getrandint(<span class="hljs-number">17</span>) &lt;&lt; <span class="hljs-number">8</span>))<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">encrypt</span>(<span class="hljs-params">self,msg:<span class="hljs-built_in">list</span>[<span class="hljs-built_in">int</span>] | <span class="hljs-built_in">bytes</span></span>):<br>        result = []<br>        <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> msg:<br>            tmp = <span class="hljs-number">0</span><br>            shuffle_base = urandom(<span class="hljs-number">16</span>)<br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> shuffle_base:<br>                x,y = <span class="hljs-built_in">divmod</span>(i,<span class="hljs-number">16</span>)<br>                tmp += x*<span class="hljs-variable language_">self</span>.pubkeys[y] + y*<span class="hljs-variable language_">self</span>.pubkeys[x]<br>            result.append(tmp + m)<br>        <span class="hljs-keyword">return</span> result<br></code></pre></td></tr></table></figure>
<p>题目的意思很简单，恢复字符串string，然后解密AES即可。<br>通过观察FHE的encrypt函数，我们不难得出<code>msg=result%p%256</code><br><code>result%p</code>能得到<code>getrandint(17) &lt;&lt; 8+m</code>，而<code>getrandint(17) &lt;&lt; 8</code>的低8位正好是0，<code>%256</code>即可得到msg。<br>求出mag后我们就可以恢复<code>s[4:]</code>的值了，并且因为这20000bits是通过random模块生成的，random模块采用的是MT19937作为伪随机数生成器的，所以我们可以逆向MT19937来获得<code>s[:4]</code><br>得到了<code>s[:4]</code>后我们就可以恢复string了，具体细节之后再说<br>所以问题就变成了如何得到p。<br>嗯…比赛的卡这了，所以来看wp吧~<br><img src="/2025/03/29/2025-3-22NCTF/3.png" srcset="/img/loading.gif" lazyload><br><img src="/2025/03/29/2025-3-22NCTF/4.png" srcset="/img/loading.gif" lazyload><br><img src="/2025/03/29/2025-3-22NCTF/5.png" srcset="/img/loading.gif" lazyload><br>这是一个求近似最大公约数问题(AGCD&#x2F;Approximate Greatest Common Divisor)。<br>所以，上格。</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs txt">x0=p*q0+e0+m0<br>xi=p*qi+ei+mi<br>-&gt;<br>x0*qi=p*q0*qi+(e0+m0)*qi<br>xi*q0=p*qi*q0+(ei+mi)*q0<br>两式相减<br>x0*qi-xi*q0=(e0+m0)*qi-(ei+mi)*q0<br></code></pre></td></tr></table></figure>
<p>我们通过构造上面的格就可以还原出q0，进而求出p。<br>值得一提的是求出来的q0需要abs一下，因为LLL求出来的是最短向量，是有可能为负的，相比之下BKZ求出负值的概率就小一点了，但依旧存在。以及格中的短向量<code>2**(ρ+1)</code>的值在很大程度上并不影响结果，取1都可以。<br>这里给出我复现时的求p的脚本:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sage">Keys=[]<br>B=[[0]*length for i in range(length)]<br>for i in range(length-1):<br>    B[i][i]=Keys[j*2500+0]<br>    B[-1][i]=Keys[j*2500+i+1]<br>B[-1][-1]=k<br>B=matrix(ZZ,B)<br>B_=B.LLL()<br><br>q0=abs(B_[0][-1])//k<br>p=((Keys[j*2500]-Keys[j*2500]%q0)//q0)<br></code></pre></td></tr></table></figure>
<p>求出p后我们就可以得到<code>s[4:]</code><br>接下来需要求出<code>s[:4]</code><br>这里涉及到random生成固定位数的随机数的方式<br>下面的拼接都是以16进制字符串的形式进行的拼接，不是加法<br>对于32位以下的随机数，比如<code>getrandbits(16)</code>，random会先生成32位的随机数然后截断，只取前16位然后return<br>对于32位以上的随机数，比如<code>getrandbits(64)</code>，random会生成2个32位是随机数，再进行拼接，后生成的随机数拼接在先生成的随机数的前面，即<code>后生成的32位随机数+先生成的32位随机数</code>，对于不是32的倍数的bits的随机数，比如<code>getrandbits(80)</code>，random会先按前面的方法生成64位随机数，再按32位一下的随机数的生成方法来生成16位的随机数，后生成的永远排在先生成的前面，即<code>截断成16位的第3次生成的随机数+32位的第2次生成的随机数+32位的第1次生成的随机数</code><br>所以，得到<code>s[:4]</code>的方法很明确了，通过<code>s[4:]</code>来逆向MT19937，然后再生成一个32位的随机数就是<code>s[:4]</code>了。<br>我复现的时候就是没弄清楚然后调了好久，一直以为<code>s[:4]</code>是最先生成的32位随机数，还找了相关的脚本，这里顺便也贴一下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> random<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">inv_shift_right</span>(<span class="hljs-params">x:<span class="hljs-built_in">int</span>,bit:<span class="hljs-built_in">int</span>,mask:<span class="hljs-built_in">int</span> = <span class="hljs-number">0xffffffff</span></span>) -&gt; <span class="hljs-built_in">int</span>:<br>    tmp = x <br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">32</span>//bit):<br>        tmp = x ^ tmp &gt;&gt; bit &amp; mask<br>    <span class="hljs-keyword">return</span> tmp<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">inv_shift_left</span>(<span class="hljs-params">x:<span class="hljs-built_in">int</span>,bit:<span class="hljs-built_in">int</span>,mask:<span class="hljs-built_in">int</span> = <span class="hljs-number">0xffffffff</span></span>) -&gt; <span class="hljs-built_in">int</span>:<br>    tmp = x<br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">32</span>//bit):<br>        tmp = x ^ tmp &lt;&lt; bit &amp; mask<br>    <span class="hljs-keyword">return</span> tmp<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rev_extract</span>(<span class="hljs-params">y:<span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:<br>    y = inv_shift_right(y,<span class="hljs-number">18</span>)<br>    y = inv_shift_left(y,<span class="hljs-number">15</span>,<span class="hljs-number">4022730752</span>)<br>    y = inv_shift_left(y,<span class="hljs-number">7</span>,<span class="hljs-number">2636928640</span>)<br>    y = inv_shift_right(y,<span class="hljs-number">11</span>)<br>    <span class="hljs-keyword">return</span> y<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">backtrace_untwist</span>(<span class="hljs-params">cur</span>):<br>    high = <span class="hljs-number">0x80000000</span><br>    low = <span class="hljs-number">0x7fffffff</span><br>    mask = <span class="hljs-number">0x9908b0df</span><br>    state = cur<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">623</span>,-<span class="hljs-number">1</span>,-<span class="hljs-number">1</span>):<br>        tmp = state[i]^state[(i+<span class="hljs-number">397</span>)%<span class="hljs-number">624</span>]<br>        <span class="hljs-comment"># recover Y,tmp = Y</span><br>        <span class="hljs-keyword">if</span> tmp &amp; high == high:<br>            tmp ^= mask<br>            tmp &lt;&lt;= <span class="hljs-number">1</span><br>            tmp |= <span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            tmp &lt;&lt;=<span class="hljs-number">1</span><br>        <span class="hljs-comment"># recover highest bit</span><br>        res = tmp&amp;high<br>        <span class="hljs-comment"># recover other 31 bits,when i =0,it just use the method again it so beautiful!!!!</span><br>        tmp = state[i-<span class="hljs-number">1</span>]^state[(i+<span class="hljs-number">396</span>)%<span class="hljs-number">624</span>]<br>        <span class="hljs-comment"># recover Y,tmp = Y</span><br>        <span class="hljs-keyword">if</span> tmp &amp; high == high:<br>            tmp ^= mask<br>            tmp &lt;&lt;= <span class="hljs-number">1</span><br>            tmp |= <span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            tmp &lt;&lt;=<span class="hljs-number">1</span><br>        res |= (tmp)&amp;low<br>        state[i] = res    <br>    <span class="hljs-keyword">return</span> state<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp_mt19937</span>(<span class="hljs-params">output:<span class="hljs-built_in">list</span></span>) -&gt; <span class="hljs-built_in">int</span>:<br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(output) == <span class="hljs-number">624</span><br>    cur_stat = [rev_extract(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> output]<br>    <span class="hljs-keyword">return</span> cur_stat<br><br>random.seed(<span class="hljs-number">1</span>)<br>l=[random.getrandbits(<span class="hljs-number">32</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">624</span>)]<br>stat=exp_mt19937(l)<br>stat=backtrace_untwist(stat)<br>r=random.Random()<br>r.setstate((<span class="hljs-number">3</span>, <span class="hljs-built_in">tuple</span>(stat + [<span class="hljs-number">624</span>]), <span class="hljs-literal">None</span>))<br><span class="hljs-keyword">assert</span> r.getrandbits(<span class="hljs-number">32</span>)==l[<span class="hljs-number">0</span>]<br><span class="hljs-comment">#要求l序列之前的值，只需要更改setstate里面的624即可，每减一就是向前推一个</span><br>r.setstate((<span class="hljs-number">3</span>, <span class="hljs-built_in">tuple</span>(stat + [<span class="hljs-number">623</span>]), <span class="hljs-literal">None</span>))<br>r.getrandbits(<span class="hljs-number">32</span>)<br><span class="hljs-keyword">assert</span> r.getrandbits(<span class="hljs-number">32</span>)==l[<span class="hljs-number">0</span>]<br></code></pre></td></tr></table></figure>
<p>这里提一下，random每生成624个随机数后就会调用一次twist来更新内部的state，也就是说我们向前面逆向每624个随机数就要调用一次backtrace_untwist。不明白的可以自己尝试一下，这里不多说了。<br>好的，我们回到题目中去。<br>刚刚我们做到了逆向MT19937这一步，接下来我们需要的就是用<code>s[4:]</code>来逆向获取MT19937的内部状态，然后再根据这个来得到下一个32位的随机数，就是<code>s[:4]</code>，逆向MT19937的方法我目前知道2个，一个是用randcrack这个库，你只需要提交624个32位的随机数，然后调用<code>predic_getrandbits(32)</code>即可，挺方便的。另一个就是用和上面差不多的脚本，只不过就是不需要调用backtrace_untwist来转换状态了。把exp_mt19937返回的state直接传入r.setstate里即可。<br>这里给出我复现时的脚本。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs sage">from Crypto.Util.number import *<br>from hashlib import md5<br>from Crypto.Cipher import AES<br>from random import Random<br><br>def inv_shift_right(x:int,bit:int,mask:int = 0xffffffff) -&gt; int:<br>    tmp = x <br>    for _ in range(32//bit):<br>        tmp = x ^^ tmp &gt;&gt; bit &amp; mask<br>    return tmp<br><br>def inv_shift_left(x:int,bit:int,mask:int = 0xffffffff) -&gt; int:<br>    tmp = x<br>    for _ in range(32//bit):<br>        tmp = x ^^ tmp &lt;&lt; bit &amp; mask<br>    return tmp<br><br>def rev_extract(y:int) -&gt; int:<br>    y = inv_shift_right(y,18)<br>    y = inv_shift_left(y,15,4022730752)<br>    y = inv_shift_left(y,7,2636928640)<br>    y = inv_shift_right(y,11)<br>    return y<br><br>def backtrace_untwist(cur):<br>    high = 0x80000000<br>    low = 0x7fffffff<br>    mask = 0x9908b0df<br>    state = cur<br>    for i in range(623,-1,-1):<br>        tmp = state[i]^^state[(i+397)%624]<br>        # recover Y,tmp = Y<br>        if tmp &amp; high == high:<br>            tmp ^^= mask<br>            tmp &lt;&lt;= 1<br>            tmp |= 1<br>        else:<br>            tmp &lt;&lt;=1<br>        # recover highest bit<br>        res = tmp&amp;high<br>        # recover other 31 bits,when i =0,it just use the method again it so beautiful!!!!<br>        tmp = state[i-1]^^state[(i+396)%624]<br>        # recover Y,tmp = Y<br>        if tmp &amp; high == high:<br>            tmp ^^= mask<br>            tmp &lt;&lt;= 1<br>            tmp |= 1<br>        else:<br>            tmp &lt;&lt;=1<br>        res |= (tmp)&amp;low<br>        state[i] = res    <br>    return state<br><br>def exp_mt19937(output:list) -&gt; int:<br>    assert len(output) == 624<br>    cur_stat = [rev_extract(i) for i in output]<br>    r = Random()<br>    r.setstate((3, tuple([int(i) for i in cur_stat] + [624]), None))<br>    return r<br><br>length=21<br>k=1<br>string=b&#x27;&#x27;<br>for j in range(12):<br>    B=[[0]*length for i in range(length)]<br>    for i in range(length-1):<br>        B[i][i]=Keys[j*2500+0]<br>        B[-1][i]=Keys[j*2500+i+1]<br>    B[-1][-1]=k<br>    B=matrix(ZZ,B)<br>    B_=B.LLL()<br><br>    q0=abs(B_[0][-1])//k<br>    p=((Keys[j*2500]-Keys[j*2500]%q0)//q0)<br>    #p=p+p%2-1<br>    print(p)<br><br>    ilist=[Keys[j*2500+i]%p%256 for i in range(2500)]<br>    r=exp_mt19937([bytes_to_long(bytes(ilist[i:i+4])) for i in range(0,2496,4)][::-1])<br>    s=list(long_to_bytes(r.getrandbits(32)))<br>    __l=[]<br>    for i in range(4):<br>        if s[i]!=0:<br>            m_=ilist[2496+i]*inverse(s[i],0x101)%0x101<br>            __l+=[bin(m_)[2:].zfill(2)]<br>        else:<br>            __l+=[&#x27;00&#x27;]<br>    __l=__l[::-1]<br>    m=long_to_bytes(int(&#x27;&#x27;.join(__l),2))<br>    print(m)<br>    string+=m<br>print(string)<br>print(AES.new(md5(string).digest(),AES.MODE_ECB).decrypt(long_to_bytes(int(cipher,16))))<br></code></pre></td></tr></table></figure>
<p>官方wp(官方wp里没有对求出来的q取abs):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs sage"># sage<br>__import__(&#x27;os&#x27;).environ[&#x27;TERM&#x27;] = &#x27;xterm&#x27;<br>from sage.all import *<br>from Crypto.Util.number import *<br>from functools import reduce<br>from random import *<br>from pwn import *<br>from Crypto.Util.Padding import unpad<br>from Crypto.Cipher import AES<br>from hashlib import md5<br><br><br>def inv_shift_right(x: int, bit: int, mask: int = 0xffffffff) -&gt; int:<br>    tmp = x<br>    for _ in range(32 // bit):<br>        tmp = x ^ tmp &gt;&gt; bit &amp; mask<br>    return tmp<br><br><br>def inv_shift_left(x: int, bit: int, mask: int = 0xffffffff) -&gt; int:<br>    tmp = x<br>    for _ in range(32 // bit):<br>        tmp = x ^ tmp &lt;&lt; bit &amp; mask<br>    return tmp<br><br><br>def rev_extract(y: int) -&gt; int:<br>    y = inv_shift_right(y, 18)<br>    y = inv_shift_left(y, 15, 4022730752)<br>    y = inv_shift_left(y, 7, 2636928640)<br>    y = inv_shift_right(y, 11)<br>    return y<br><br><br>def exp_mt19937(output: list) -&gt; int:<br>    assert len(output) == 624<br>    cur_stat = [rev_extract(i) for i in output]<br>    r = Random()<br>    r.setstate((3, tuple([int(i) for i in cur_stat] + [624]), None))<br>    return r.getrandbits(32)<br><br><br>io = remote(&#x27;39.106.16.204&#x27;, 24259)<br>io.recvuntil(b&#x27;:&#x27;)<br>aes_cipher = bytes.fromhex(io.recvline().strip().decode())<br>io.sendlineafter(b&#x27;:&#x27;, b&#x27;&#x27;)<br>msg = []<br>for _ in range(30000):<br>    io.recvuntil(b&#x27;[+]&#x27;)<br>    msg.append(int(io.recvline().strip().decode()))<br><br>io.close()<br>msg = [msg[i:i + 2500] for i in range(0, 30000, 2500)]<br><br>d1 = []<br>for dx in range(12):<br>    cp = msg[dx]<br><br>    mt = matrix(ZZ, 21, 21)<br>    for i in range(20):<br>        mt[i, i] = cp[-1]<br>        mt[-1, i] = cp[i]<br>    const = 2 ** 30<br>    mt[-1, -1] = const<br>    mt = mt.LLL()<br><br>    temp = abs(mt[0, -1])<br>    assert temp % const == 0<br><br>    q0 = temp / const<br>    e0 = ZZ(cp[-1] % q0)<br>    p = ZZ((cp[-1] - e0) / q0)<br><br>    d1.append(list(map(lambda x: x % p % 256, cp)))<br><br>d2 = b&#x27;&#x27;<br><br>for dx in range(12):<br>    ran_output = [bytes_to_long(bytes(d1[dx][i:i + 4])) for i in range(0, 2496, 4)]<br>    invmul_key = [pow(i, -1, 0x101) for i in long_to_bytes(exp_mt19937(ran_output[::-1]))]<br><br>    res = []<br>    for i in range(4):<br>        res.append(invmul_key[i] * d1[dx][-4 + i] % 0x101)<br><br>    assert all(0 &lt;= i &lt; 4 for i in res)<br>    res.reverse()<br>    d2 += bytes([reduce(lambda x, y: 4 * x + y, res)])<br><br>print(unpad(AES.new(md5(d2).digest(), AES.MODE_ECB).decrypt(aes_cipher), 16).decode())<br></code></pre></td></tr></table></figure>

<h2 id="Arcahv"><a href="#Arcahv" class="headerlink" title="Arcahv"></a>Arcahv</h2><p>Delightful.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> os <span class="hljs-keyword">import</span> urandom,getenv<br><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> reduce<br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">LCG</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,seed:<span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-variable language_">self</span>.p = getPrime(<span class="hljs-number">1024</span>)<br>        <span class="hljs-variable language_">self</span>.a = getPrime(<span class="hljs-number">1023</span>)<br>        <span class="hljs-variable language_">self</span>.b = getPrime(<span class="hljs-number">1023</span>)<br>        <span class="hljs-variable language_">self</span>.status = seed<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">next</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">int</span>:<br>        ret = <span class="hljs-variable language_">self</span>.status<br>        <span class="hljs-variable language_">self</span>.status = (<span class="hljs-variable language_">self</span>.status * <span class="hljs-variable language_">self</span>.a + <span class="hljs-variable language_">self</span>.b) % <span class="hljs-variable language_">self</span>.p<br>        <span class="hljs-keyword">return</span> ret<br>    <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">crystal_trick</span>(<span class="hljs-params">m:<span class="hljs-built_in">bytes</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    m = <span class="hljs-built_in">bytearray</span>(m)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(m)):<br>        m[i] = reduce(<span class="hljs-keyword">lambda</span> x,y: x^y^urandom(<span class="hljs-number">1</span>)[<span class="hljs-number">0</span>],m[:i],m[i])<br>    <span class="hljs-keyword">return</span> m<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RSA</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        p = getStrongPrime(<span class="hljs-number">1024</span>)<br>        q = getStrongPrime(<span class="hljs-number">1024</span>)<br>        <span class="hljs-variable language_">self</span>.p = p<br>        <span class="hljs-variable language_">self</span>.N = p * q<br>        <span class="hljs-variable language_">self</span>.e = <span class="hljs-number">65537</span><br>        <span class="hljs-variable language_">self</span>.d = <span class="hljs-built_in">pow</span>(<span class="hljs-variable language_">self</span>.e, -<span class="hljs-number">1</span>, (p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>))<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">encrypt</span>(<span class="hljs-params">self,m:<span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">pow</span>(m,<span class="hljs-variable language_">self</span>.e,<span class="hljs-variable language_">self</span>.N)<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt</span>(<span class="hljs-params">self,c:<span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">pow</span>(c,<span class="hljs-variable language_">self</span>.d,<span class="hljs-variable language_">self</span>.N) <br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyRSA1</span>(<span class="hljs-title class_ inherited__">RSA</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">encrypt</span>(<span class="hljs-params">self,m:<span class="hljs-built_in">bytes</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>().encrypt(<span class="hljs-built_in">int</span>.from_bytes(m)).to_bytes(<span class="hljs-number">256</span>)<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt</span>(<span class="hljs-params">self,c:<span class="hljs-built_in">bytes</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>().decrypt(<span class="hljs-built_in">int</span>.from_bytes(c)).to_bytes(<span class="hljs-number">256</span>)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyRSA2</span>(<span class="hljs-title class_ inherited__">RSA</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">encrypt</span>(<span class="hljs-params">self,m:<span class="hljs-built_in">bytes</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">pow</span>(<span class="hljs-built_in">int</span>.from_bytes(m),<span class="hljs-variable language_">self</span>.e,<span class="hljs-variable language_">self</span>.N).to_bytes(<span class="hljs-number">256</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt</span>(<span class="hljs-params">self,c:<span class="hljs-built_in">bytes</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>        m = <span class="hljs-built_in">pow</span>(<span class="hljs-built_in">int</span>.from_bytes(c),<span class="hljs-variable language_">self</span>.d,<span class="hljs-variable language_">self</span>.N).to_bytes(<span class="hljs-number">256</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Hibiscus is here to trick your decryption result!!&#x27;</span>)<br>        <span class="hljs-keyword">return</span> crystal_trick(m)<br><br>menu = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">Welcome to NCTF 2025 arcahv challenge!</span><br><span class="hljs-string"></span><br><span class="hljs-string">--- Menu ---</span><br><span class="hljs-string">[1] View encrypted flag and hint</span><br><span class="hljs-string">[2] Play with the decryption orcale</span><br><span class="hljs-string">[3] Get some random numbers for fun</span><br><span class="hljs-string">[4] Exit</span><br><span class="hljs-string"></span><br><span class="hljs-string">Your Option &gt; &#x27;&#x27;&#x27;</span><br><br><br><span class="hljs-keyword">if</span> __name__==<span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Loading, please wait...&#x27;</span>)<br>    <br>    <span class="hljs-comment"># flag = open(&#x27;flag.txt&#x27;).read().strip().encode()</span><br>    flag = getenv(<span class="hljs-string">&#x27;FLAG&#x27;</span>).encode()<br>    attempts = <span class="hljs-number">75</span><br>    r1 = MyRSA1()<br>    r2 = MyRSA2()<br>    hint1 = r2.encrypt(r1.p.to_bytes(<span class="hljs-number">128</span>))<br><br>    key = urandom(<span class="hljs-number">16</span>)<br>    hint2 = AES.new(key,AES.MODE_ECB).encrypt(r1.N.to_bytes(<span class="hljs-number">256</span>))<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">flag_and_hint</span>():<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;Encrypted flag: <span class="hljs-subst">&#123;r1.encrypt(flag).<span class="hljs-built_in">hex</span>()&#125;</span>&#x27;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;Hint1: <span class="hljs-subst">&#123;hint1.<span class="hljs-built_in">hex</span>()&#125;</span>&#x27;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;Hint2: <span class="hljs-subst">&#123;hint2.<span class="hljs-built_in">hex</span>()&#125;</span>&#x27;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">rsachal</span>(): <br>        <span class="hljs-keyword">global</span> attempts<br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Since you didn&#x27;t v Hibiscus 50 on crazy thursday, Hibiscus decided to do some trick on your decryption result!&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;Your pubkey:(<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(r2.N)[<span class="hljs-number">2</span>:]&#125;</span>,<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(r2.e)[<span class="hljs-number">2</span>:]&#125;</span>)&#x27;</span>)<br><br>        <span class="hljs-keyword">while</span> attempts &gt; <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;Do you still want to try decryption(y/[n])?&#x27;</span>) != <span class="hljs-string">&#x27;y&#x27;</span>:<br>                <span class="hljs-keyword">break</span><br><br>            c = <span class="hljs-built_in">bytes</span>.fromhex(<span class="hljs-built_in">input</span>(<span class="hljs-string">f&#x27;You have <span class="hljs-subst">&#123;attempts&#125;</span> remaining access to decryption orcale!\nYour ciphertext(in hex):&#x27;</span>))<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;Result: <span class="hljs-subst">&#123;r2.decrypt(c).<span class="hljs-built_in">hex</span>()&#125;</span>&#x27;</span>)<br>            attempts -= <span class="hljs-number">1</span><br>        <br>        <span class="hljs-keyword">if</span> attempts == <span class="hljs-number">0</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Unfortunately, you are out of decryption attempts! Come back again on nctf2026 ~&#x27;</span>)<br><br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">lcgchal</span>():<br>        lcg = LCG(<span class="hljs-built_in">int</span>.from_bytes(key))<br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Tempering with LCG generator, please wait...&#x27;</span>)<br>        <span class="hljs-keyword">while</span> urandom(<span class="hljs-number">1</span>)[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0xff</span>:<br>            lcg.<span class="hljs-built_in">next</span>()<br>        <br>        hexnums = <span class="hljs-string">&#x27;&#x27;</span>.join(<span class="hljs-built_in">hex</span>(lcg.<span class="hljs-built_in">next</span>())[<span class="hljs-number">2</span>:] <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>))<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(hexnums) % <span class="hljs-number">16</span>:<br>            hexnums = hexnums.zfill((<span class="hljs-built_in">len</span>(hexnums) // <span class="hljs-number">16</span> + <span class="hljs-number">1</span>) * <span class="hljs-number">16</span>)<br>        <br>        idx = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;Do you want another unsigned long long number(y/[n])?&#x27;</span>) == <span class="hljs-string">&#x27;y&#x27;</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-built_in">int</span>(<span class="hljs-string">&#x27;&#x27;</span>.join(hexnums[idx:idx+<span class="hljs-number">16</span>]),<span class="hljs-number">16</span>))<br>            idx = (idx + <span class="hljs-number">16</span>) % <span class="hljs-built_in">len</span>(hexnums)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">bye</span>():<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Hope you have fun during the challenge XD:)&#x27;</span>)<br>        exit(<span class="hljs-number">0</span>)<br><br>    fundc = &#123;<span class="hljs-number">1</span>:flag_and_hint,<span class="hljs-number">2</span>:rsachal,<span class="hljs-number">3</span>:lcgchal,<span class="hljs-number">4</span>:bye&#125;<br><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        opt = <span class="hljs-built_in">input</span>(menu)<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(opt) == <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> opt <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;1234&#x27;</span>:<br>            opt = <span class="hljs-string">&#x27;4&#x27;</span><br>        fundc[<span class="hljs-built_in">int</span>(opt)]()<br></code></pre></td></tr></table></figure>
<p>很麻烦，感觉很麻烦。感觉可以分成两道题了。<br>wp里也说了这是大杂烩，你能看到RSA LSB Orcale,LCG,Coppersmith。<br>这题比赛时也是只有大致的思路，具体攻击不会。<br>题目大致可以分成2部分，第一部分的RSA，通过RSA LSB Orcale来获得r1.p。<br>第二部分就是LCG，LCG生成的数的16进制的长度基本可以认为长度是256，有可能会出现255长度的情况，但只要多试一下就可以了。得到数后就是套公式了。<br>最后解个RSA就可以得到flag了<br>那么这题主要就是第一部分的RSA LSB Orcale了。<br>这个我复现的时候也是想了很久，有些地方wp里没有指出来。先把wp放出来。<br><img src="/2025/03/29/2025-3-22NCTF/6.png" srcset="/img/loading.gif" lazyload><br>一点点来看吧。<br>首先介绍一下乘法同态，说白了就是你将2个密文相乘，再解密，明文也会是2个明文相乘。类似的还有加法同态，只是把乘法换成了加法，你将2个密文相加，再解密，明文也会是2个明文相加。同时具有加法同态和乘法同态的，我们称之为全同态，也就是上面的FHE。<br>很明显，RSA具有乘法同态，这个稍微推一下就能出来。<br>那么我们就可以通过改变密文来使解出来的明文乘以一个确定的数。<br>如果我们将密文乘C*<em>e，那么解出来的明文将会是原来的C倍。<br>因为这题我们可以得到明文mod 256的结果(256位以上的都被crystal_trick改变了，没办法得到)，所以我们取C为256。<br>因为m是小于n的，所以我们可以得到256</em>m%256&#x3D;0，这个在C较小的时候是恒成立的。但当C较大时，也就是说存在一个数a，<code>C=256**a</code>，使得<code>m*C&gt;n</code>，那么这时候就存在等式<code>m&#39;=C*m-k*n</code>(m’是更改密文后解出来的明文的值)，其中k是正数。我们只能得到模256下的值，所以我们对两边模256，得到<code>m&#39;=-k*n (mod 256)</code>，易得<code>k=-m&#39;*n**(-1) (mod 256)</code><br>同时我们要明确一点，这里<code>C=256**a</code>的a是使得<code>C*m&gt;n</code>的最小的a，也就是说k不会很大，我们可以认为<code>k&lt;256</code>，也就是说我们可以认为在模256下求出来的k就是k。<br>所以，我们可以回到最开始的等式<code>C*m=m&#39;+k*n</code>，<code>m&#39;&lt;n</code>，那么<code>C*m</code>就在<code>k*n</code>和<code>(k+1)*n</code>之间。即<code>k*n/256**a&lt;m&lt;(k+1)*n/256**a</code>，我们就得到了m的一个范围。<br>我们令<code>a=a+1</code>，即密文再乘一个<code>256**e</code>，即在<code>m&#39;=C*m-k*n</code>两边再乘以一个256，我们可以得到<code>256*m&#39;=256*C*m-256*k*n</code>，其中<code>256*m&#39;</code>是有可能大于n的，而解密出来<code>m&#39;&#39;</code>是小于n的，有等式<code>m&#39;&#39;=256*m&#39;-k2*n</code>，<code>m&#39;&#39;+k2*n=256*m&#39;</code>，代回去得到<code>m&#39;&#39;+k2*n=256*C*m-256*k1*n</code>，<code>m&#39;&#39;=256**(a+1)*m-256*k1*n-k2*n</code>，<code>m&#39;&#39;=256**(a+1)*m-(256*k1+k2)*n</code>，重复上述步骤后能得到<code>256*k1+k2 mod 256</code>的值，即k2，k1前面已经得到，所以我们可以再次缩小m的范围，<code>(256*k1+k2)*n/256**a&lt;m&lt;((256*k1+k2)+1)*n/256**a</code>。这样每次都能把m的范围缩小<code>1/256</code>，最后我们可以得到一个足够小的范围，其中左边界和右边界的高600位是相同的，也就是说我们获得了<code>r1.p</code>的高600位信息，在后面LCG里得到了n后用coppersmith可以很容易求出<code>r1.p</code>。<br>下面我重新整理一下推理的过程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs math">取一个a，C=256**a，使得C*m&gt;n<br>m&#x27;是解密后的明文<br>m&#x27;=C*m-k*n=256**a*m-k*n<br>m&#x27;=-k*n (mod n)<br>k=-m&#x27;*n**(-1) (mod 256)<br>k=-(m&#x27; mod 256)*n**(-1) (mod 256)<br>再看等式256**a*m=m&#x27;+k*n<br>=&gt;k*n/256**a&lt;m&lt;(k+1)*n/256**a<br><br>256*m&#x27;=256*C*m-256*k*n<br>其中:256*m&#x27;=m&quot;+k2*n<br>m&quot;+k2*n=256*C*m-256*k1*n<br>m&quot;=256*C*m-256*k1*n-k2*n<br>m&quot;=256*C*m-(256*k1+k2)*n<br>m&quot;=-(256*k1+k2)*n (mod 256)<br>256*k1+k2=-m&quot;*n**(-1) (mod 256)<br>k2=-(m&quot; mod 256)*n**(-1) (mod 256)<br>再看等式256**(a+1)*m=m&quot;+(256*k1+k2)*n<br>=&gt;(256*k1+k2)*n/256**(a+1)&lt;m&lt;((256*k1+k2)+1)*n/256**(a+1)<br></code></pre></td></tr></table></figure>
<p>这里给出我复现的脚本:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> reduce<br><span class="hljs-keyword">from</span> os <span class="hljs-keyword">import</span> urandom,getenv<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">crystal_trick</span>(<span class="hljs-params">m:<span class="hljs-built_in">bytes</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    m = <span class="hljs-built_in">bytearray</span>(m)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(m)):<br>        m[i] = reduce(<span class="hljs-keyword">lambda</span> x,y: x^y^urandom(<span class="hljs-number">1</span>)[<span class="hljs-number">0</span>],m[:i],m[i])<br>    <span class="hljs-keyword">return</span> m<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RSA</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        p = getStrongPrime(<span class="hljs-number">1024</span>)<br>        q = getStrongPrime(<span class="hljs-number">1024</span>)<br>        <span class="hljs-variable language_">self</span>.p = p<br>        <span class="hljs-variable language_">self</span>.N = p * q<br>        <span class="hljs-variable language_">self</span>.e = <span class="hljs-number">65537</span><br>        <span class="hljs-variable language_">self</span>.d = <span class="hljs-built_in">pow</span>(<span class="hljs-variable language_">self</span>.e, -<span class="hljs-number">1</span>, (p-<span class="hljs-number">1</span>)*(q-<span class="hljs-number">1</span>))<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">encrypt</span>(<span class="hljs-params">self,m:<span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">pow</span>(m,<span class="hljs-variable language_">self</span>.e,<span class="hljs-variable language_">self</span>.N)<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt</span>(<span class="hljs-params">self,c:<span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">pow</span>(c,<span class="hljs-variable language_">self</span>.d,<span class="hljs-variable language_">self</span>.N) <br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyRSA1</span>(<span class="hljs-title class_ inherited__">RSA</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">encrypt</span>(<span class="hljs-params">self,m:<span class="hljs-built_in">bytes</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>().encrypt(<span class="hljs-built_in">int</span>.from_bytes(m)).to_bytes(<span class="hljs-number">256</span>)<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt</span>(<span class="hljs-params">self,c:<span class="hljs-built_in">bytes</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>().decrypt(<span class="hljs-built_in">int</span>.from_bytes(c)).to_bytes(<span class="hljs-number">256</span>)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyRSA2</span>(<span class="hljs-title class_ inherited__">RSA</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">encrypt</span>(<span class="hljs-params">self,m:<span class="hljs-built_in">bytes</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">pow</span>(<span class="hljs-built_in">int</span>.from_bytes(m),<span class="hljs-variable language_">self</span>.e,<span class="hljs-variable language_">self</span>.N).to_bytes(<span class="hljs-number">256</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt</span>(<span class="hljs-params">self,c:<span class="hljs-built_in">bytes</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>        m = <span class="hljs-built_in">pow</span>(<span class="hljs-built_in">int</span>.from_bytes(c),<span class="hljs-variable language_">self</span>.d,<span class="hljs-variable language_">self</span>.N).to_bytes(<span class="hljs-number">256</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Hibiscus is here to trick your decryption result!!&#x27;</span>)<br>        <span class="hljs-keyword">return</span> crystal_trick(m)<br><br><br>attempts = <span class="hljs-number">75</span><br>r1 = MyRSA1()<br>r2 = MyRSA2()<br><br>hint1 = r2.encrypt(r1.p.to_bytes(<span class="hljs-number">128</span>))<br><br>e=r2.e<br>n=r2.N<br><br>c=bytes_to_long(hint1[::-<span class="hljs-number">1</span>])<br>c=c*<span class="hljs-built_in">pow</span>(<span class="hljs-built_in">pow</span>(<span class="hljs-number">256</span>,e,n),<span class="hljs-number">127</span>,n)%n<br>k=<span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(attempts):<br>    c=c*<span class="hljs-built_in">pow</span>(<span class="hljs-number">256</span>,e,n)<br>    p=bytes_to_long(r2.decrypt(long_to_bytes(c))[::-<span class="hljs-number">1</span>])<br>    k=k*<span class="hljs-number">256</span>+(-inverse(n,<span class="hljs-number">256</span>)*p%<span class="hljs-number">256</span>)<br>    <br><span class="hljs-built_in">print</span>(k*n&lt;=r1.p*<span class="hljs-number">256</span>**<span class="hljs-number">202</span>&lt;=(k+<span class="hljs-number">1</span>)*n)<br><span class="hljs-comment">#True</span><br><br>left=k*n//<span class="hljs-number">256</span>**<span class="hljs-number">202</span><br><span class="hljs-built_in">print</span>(left)<br><span class="hljs-comment">#130885664743289933041962413621767865441591321317558885014199074466855996631539798687727640403945760110268413946434133511019400476370469967300594876528558048910115238902971140792455911038756167472065922832612114808088205280482352816705878339397975785484133224023653016197364452594597283624017262470813673995009</span><br><br>right=(k+<span class="hljs-number">1</span>)*n//<span class="hljs-number">256</span>**<span class="hljs-number">202</span><br>left=<span class="hljs-built_in">bin</span>(left)[<span class="hljs-number">2</span>:]<br>right=<span class="hljs-built_in">bin</span>(right)[<span class="hljs-number">2</span>:]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(left)):<br>    <span class="hljs-keyword">if</span> left[i]!=right[i]:<br>        <span class="hljs-built_in">print</span>(i+<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">break</span><br><span class="hljs-built_in">print</span>(<span class="hljs-number">1024</span>-i-<span class="hljs-number">1</span>)<br><span class="hljs-comment">#433</span><br></code></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sage">p=130885664743289933041962413621767865441591321317558885014199074466855996631539798687727640403945760110268413946434133511019400476370469967300594876528558048910115238902971140792455911038756167472065922832612114808088205280482352816705878339397975785484133224023653016197364452594597283624017262470813673995009<br>n=22404304571663619533801749171851644355131031548896050596784492860131952108418133799362203562452927755672086256671456886275374200290455900981573098592802256957759447612198108603737786271333540992054310231142238002312019309261407284535898443221193784771270772676264595891893528938890406282960473610037440992613094585895090383508341010089438083413545705058441072109863024324482039164643863226495180994062873842889196325037541415051411994025140102929000241053770118516405280808187203883977272655025293179259881406034169473289536962089680084335406639749490203495720187657339642405381585747883680749867717205896873223051129<br><br>bit=433<br>R.&lt;x&gt;=PolynomialRing(Zmod(n))<br>f=p+x<br>f=f.monic()<br>roots=f.small_roots(X=2^bit,beta=0.4)<br>print(roots)<br></code></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs result">[6941661959252282301910494977227763113291421486720572265514320326916996337372195724367188176400540935900844813645952855916156047100]<br></code></pre></td></tr></table></figure>
<p>上面我只是假设已经得到n了。<br>所以接下来我们来逆向LCG来得到n<br>自己稍微改改源码把LCG的5个数的hex给print出来，你会发现在大部分情况下的长度都是256，只有少数情况下会遇到长度是255的，遇到这种情况直接重新获取一下就好了。之后就是套公式恢复参数了。<br>这里直接贴wp了<br><img src="/2025/03/29/2025-3-22NCTF/7.png" srcset="/img/loading.gif" lazyload><br>得到了n后就可以用上面的coppersmith解出p，然后解RSA1就可以了。<br>官方wp:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs sage">#sage<br>__import__(&#x27;os&#x27;).environ[&#x27;TERM&#x27;] = &#x27;xterm&#x27;<br><br>from sage.all import *<br>from pwn import *<br>from Crypto.Util.number import *<br>from Crypto.Cipher import AES<br><br><br>def hexify_send(num: int) -&gt; bytes:<br>    return long_to_bytes(num).hex().encode()<br><br>io = remote(&#x27;39.106.16.204&#x27;, 28575)<br># io = process([&#x27;python3&#x27;, &#x27;arcahv.py&#x27;])<br><br>io.sendlineafter(b&#x27;&gt;&#x27;, b&#x27;1&#x27;)<br><br>io.recvuntil(b&#x27;:&#x27;)<br>enc_flag = int(io.recvline().strip().decode(), 16)<br>io.recvuntil(b&#x27;:&#x27;)<br>enc_hint = int.from_bytes(bytes.fromhex(io.recvline().strip().decode()), &#x27;little&#x27;)<br>io.recvuntil(b&#x27;:&#x27;)<br>enc_hint2 = bytes.fromhex(io.recvline().strip().decode())<br><br># RSA LSB Orcale<br><br>m = enc_hint<br>omit_count = 127<br>io.sendlineafter(b&#x27;&gt;&#x27;, b&#x27;2&#x27;)<br>io.recvuntil(b&#x27;(&#x27;)<br>rn = int(io.recvuntil(b&#x27;,&#x27;, drop=True).strip().decode(), 16)<br>re = int(io.recvuntil(b&#x27;)&#x27;, drop=True).strip().decode(), 16)<br><br>upper_bound = reduce(lambda x, y: floor(x / 256), range(omit_count), rn)<br><br>lower_bound = 0<br>single_mul = pow(256, re, rn)<br>inv = pow(rn, -1, 256)<br><br>m = m * pow(single_mul, omit_count, rn) % rn<br><br>for i in range(75):<br>    m = int(m * single_mul % rn)<br>    io.sendlineafter(b&#x27;?&#x27;, b&#x27;y&#x27;)<br>    io.sendlineafter(b&#x27;:&#x27;, hexify_send(m))<br>    io.recvuntil(b&#x27;:&#x27;)<br>    this = int(io.recvline().strip().decode()[:2], 16)<br>    k = int(-this * inv % 256)<br>    ttl = (upper_bound - lower_bound) / 256<br>    lower_bound += ceil(k * ttl)<br>    upper_bound = lower_bound + floor(ttl)<br><br>res_pp = lower_bound<br><br># LCG<br><br>io.sendlineafter(b&#x27;&gt;&#x27;, b&#x27;3&#x27;)<br>ls = []<br>for _ in range(80):<br>    io.sendlineafter(b&#x27;?&#x27;, b&#x27;y&#x27;)<br>    ls.append(int(io.recvline().strip().decode()))<br><br><br>hexstr = &#x27;&#x27;.join(hex(i)[2:].zfill(16) for i in ls)<br>lcgnums = [int(hexstr[i:i + 256], 16) for i in range(0, len(hexstr), 256)]<br><br><br>A = [lcgnums[i + 1] - lcgnums[i] for i in range(4)]<br>p = gcd(A[1] ** 2 - A[2] * A[0], A[2] ** 2 - A[3] * A[1])<br><br>if not isPrime(p):<br>    p = factor(p)[-1][0]<br>assert isPrime(p)<br><br>a = int(A[1] * int(pow(A[0], -1, p)) % p)<br>b = int((lcgnums[1] - a * lcgnums[0]) % p)<br><br>cur = Zmod(p)(lcgnums[0])<br>count = 0<br>while int(cur).bit_length() &gt; 128:<br>    cur = (cur - b) * pow(a, -1, p)<br>    count += 1<br><br>key = int(cur).to_bytes(16, &#x27;big&#x27;)<br>res_n = int.from_bytes(AES.new(key, AES.MODE_ECB).decrypt(enc_hint2), &#x27;big&#x27;)<br><br># Coppersmith<br>P.&lt;x&gt; = Zmod(res_n)[]<br>rt = (res_pp + x).small_roots(X=2 ** 453, beta=0.4)[0]<br><br>p0 = int(res_pp + rt)<br><br>assert res_n % p0 == 0<br>q0 = res_n // p0<br>d0 = int(pow(65537, -1, (p0 - 1) * (q0 - 1)))<br>print(long_to_bytes(int(pow(enc_flag, d0, res_n))))<br></code></pre></td></tr></table></figure>

<p>至此，三到题已经全部复现。剩下还有三题应该不会去复现了，我也没有去做过。<br>总得来说这次的NCTF的强度还是有点高的，内容也是非常的多。<br>那么就这样吧。<br><img src="/2025/03/29/2025-3-22NCTF/8.jpg" srcset="/img/loading.gif" lazyload></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/crypto/" class="category-chain-item">crypto</a>
  
  
    <span>></span>
    
  <a href="/categories/crypto/NCTF/" class="category-chain-item">NCTF</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/crypto/" class="print-no-link">#crypto</a>
      
        <a href="/tags/RSA/" class="print-no-link">#RSA</a>
      
        <a href="/tags/NCTF/" class="print-no-link">#NCTF</a>
      
        <a href="/tags/LCG/" class="print-no-link">#LCG</a>
      
        <a href="/tags/ECDSA/" class="print-no-link">#ECDSA</a>
      
        <a href="/tags/%E6%A0%BC/" class="print-no-link">#格</a>
      
        <a href="/tags/FHE/" class="print-no-link">#FHE</a>
      
        <a href="/tags/MT19937/" class="print-no-link">#MT19937</a>
      
        <a href="/tags/RSA-LSB-Orcale/" class="print-no-link">#RSA LSB Orcale</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>2025.3.22NCTF</div>
      <div>https://bddye.github.io/2025/03/29/2025-3-22NCTF/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>蹦跶的鱼儿</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年3月29日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/02/21/2025-2-3hgame/" title="2025.2.3hgame">
                        <span class="hidden-mobile">2025.2.3hgame</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
